<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Positioner</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-distortableimage/dist/leaflet.distortableimage.css"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: 'Inter', sans-serif; }
        #real-map { height: 100%; width: 100%; }
        .leaflet-distortable-image-handle { background-color: rgba(255, 255, 0, 0.8) !important; border: 2px solid #333 !important; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 10000; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem; }
    </style>
</head>
<body>
    <div id="loading-overlay">Loading Project...</div>
    <div class="flex h-screen">
        <!-- Left Panel -->
        <div class="w-1/3 max-w-sm bg-white p-4 shadow-lg overflow-y-auto flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-xl font-bold text-gray-800">Map Positioner</h1>
                <a href="/plan-editor" class="text-sm text-blue-600 hover:underline">&larr; Back to Editor</a>
            </div>
            <div id="positioner-controls" class="space-y-4">
                <p class="text-sm text-gray-600">Use the yellow handles on the map to move, scale, and rotate the plan. Click "Lock Plan" to save the position.</p>
                <button id="adjustPlanBtn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg">Adjust Plan Position</button>
                <button id="lockPlanBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg hidden">Lock Plan</button>
                <div>
                    <label for="opacity-slider" class="block text-sm font-medium text-gray-700">Plan Opacity</label>
                    <input type="range" id="opacity-slider" min="0" max="1" step="0.1" value="0.7" class="w-full">
                </div>
            </div>
        </div>
        <!-- Real Map Area -->
        <div class="flex-grow">
            <div id="real-map"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-distortableimage/dist/leaflet.distortableimage.js"></script>
    <script>
        let realMap, planOverlay;
        let project = {};
        const VANCOUVER_COORDS = [49.2827, -123.1207];

        const ui = {
            loadingOverlay: document.getElementById('loading-overlay'),
            adjustPlanBtn: document.getElementById('adjustPlanBtn'),
            lockPlanBtn: document.getElementById('lockPlanBtn'),
            opacitySlider: document.getElementById('opacity-slider')
        };

        document.addEventListener('DOMContentLoaded', async () => {
            initRealMap();
            await loadProjectData();
            setupEventListeners();
        });

        function initRealMap() {
            if (realMap) realMap.remove();
            realMap = L.map('real-map', { maxZoom: 22 }).setView(VANCOUVER_COORDS, 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(realMap);
        }

        async function loadProjectData() {
            try {
                const response = await fetch('/api/project');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                project = data.project;
                renderPlan();
                ui.loadingOverlay.style.display = 'none';
            } catch (error) {
                console.error('Error loading project:', error);
                alert('Failed to load project from server.');
            }
        }
        
        function renderPlan() {
            if (planOverlay) planOverlay.remove();
            if (!project.plan_data_url) {
                alert("No plan has been uploaded for this project.");
                return;
            }
            const options = {
                corners: project.plan_corners ? project.plan_corners.map(c => L.latLng(c.lat, c.lng)) : null
            };
            planOverlay = L.distortableImageOverlay(project.plan_data_url, options).addTo(realMap);
            ui.opacitySlider.value = project.opacity || 0.7;
            planOverlay.setOpacity(ui.opacitySlider.value);

            if (!options.corners) {
                realMap.setView(VANCOUVER_COORDS, 15);
            }
        }

        function setupEventListeners() {
            ui.adjustPlanBtn.addEventListener('click', () => {
                if (planOverlay) {
                    planOverlay.editing.enable();
                    ui.adjustPlanBtn.classList.add('hidden');
                    ui.lockPlanBtn.classList.remove('hidden');
                }
            });
            ui.lockPlanBtn.addEventListener('click', async () => {
                if (planOverlay) {
                    planOverlay.editing.disable();
                    const corners = planOverlay.getCorners();
                    await sendSettings({ plan_corners: corners });
                    ui.adjustPlanBtn.classList.remove('hidden');
                    ui.lockPlanBtn.classList.add('hidden');
                }
            });
            ui.opacitySlider.addEventListener('input', (e) => {
                if (planOverlay) planOverlay.setOpacity(e.target.value);
            });
            ui.opacitySlider.addEventListener('change', async (e) => {
                await sendSettings({ opacity: e.target.value });
            });
        }

        async function sendSettings(settings) {
            try {
                const response = await fetch('/api/project/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                if (!response.ok) throw new Error('Failed to save settings');
            } catch (err) {
                alert('Error saving settings: ' + err.message);
            }
        }
    </script>
</body>
</html>
